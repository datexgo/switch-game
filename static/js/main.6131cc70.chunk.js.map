{"version":3,"sources":["helpers/store.js","components/Cell.js","components/GameMessage.js","utils/constants.js","helpers/getAvailableWindowSize.js","helpers/getCellSize.js","components/Grid.js","components/ProgressBar.js","data/initialState.js","utils/utils.js","helpers/rand.js","helpers/pickRandom.js","helpers/decNumber.js","helpers/getNumberOfCells.js","components/Game.js","index.js","helpers/pool.js","connect.js"],"names":["Store","action$","scan","state","fn","R","Function","Error","skipDuplicates","getStyle","size","width","height","fontSize","Math","round","lineHeight","Cell","props","cell","onClick","className","style","classNames","type","inner","WAIT","label","TAP","countdown","require","GameMessage","gameIsLose","levelComplete","startingMessage","level","score","circleAnimationFrame","opacity","circleAnimationTiming","duration","iterations","getAvailableWindowSize","availHeight","window","innerHeight","innerWidth","getCellSize","length","floor","sqrt","Grid","onCellTap","cells","map","i","key","ProgressBar","animation","circle","React","createRef","this","current","animate","nextProps","value","ref","Component","initialState","gameIsPassed","best","isGameInProgress","isLevelCompleted","rand","min","max","random","pickRandom","xs","decNumber","x","Object","getNumberOfCells","lvl","connect","send","ReactDOM","render","newCellTimer","pool","K","_plug","plug","bind","Property","Stream","Observable","constant","swipe$","document","body","throttle","_","activateNextLevel","beginNewGame","ticker$","timeOut","interruptGame","updateCells","state$","startGame","initCells","activateRandomCell","String","startLevel","switchWaitToTap","numberOfCells","index","offCells","offCell","clearTimeout","setTimeout","loseStatus","streamsToProps","ComponentToWrap","activePanel","id","theme","noShadow","props$","leading","sb","observe","data","setState","subscribe","event","detail","console","log","switchBestKey","keys","find","item","unsubscribe","createElement","children","getElementById"],"mappings":"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","file":"static/js/main.6131cc70.chunk.js","sourcesContent":["import * as R from '@paqmind/ramda'\n\nfunction Store (action$) {\n  return action$\n    .scan((state, fn) => {\n      if (R.is(Function, fn)) {\n        return fn(state)\n      } else {\n        throw Error(`dispatched value must be a function, got ${typeof fn}`)\n      }\n    }, null)\n    .skipDuplicates()\n}\n\nexport default Store\n","import React from 'react'\nimport PropTypes from 'prop-types'\nimport classNames from 'classnames'\n\nconst getStyle = (size) => ({\n  width: `${size}px`,\n  height: `${size}px`,\n  fontSize: `${Math.round(size / 4)}px`,\n  lineHeight: `${Math.round(size / 2.2)}px`\n})\n\nconst Cell = (props) => {\n  const { cell, size, onClick } = props\n\n  return <div className=\"cell\" onClick={onClick} style={getStyle(size)}>\n    <div className={classNames(cell.type, {\n      inner: true,\n      WAIT: cell.label === 'WAIT',\n      TAP: cell.label === 'TAP'\n    })}>\n      <div>{cell.label === 'off' ? null : cell.label}</div>\n      <div>{cell.countdown == null ? null : cell.countdown}</div>\n    </div>\n  </div>\n}\n\nCell.propTypes = {\n  onClick: PropTypes.func.isRequired,\n  cell: PropTypes.object.isRequired,\n  size: PropTypes.number.isRequired\n}\n\nexport default Cell\n","import React from 'react'\nimport PropTypes from 'prop-types'\nconst classNames = require('classnames')\n\nconst getStyle = (size) => {\n  return {\n    width: size,\n    height: size,\n    fontSize: `${Math.round(size / 8)}px`\n  }\n}\n\nconst GameMessage = (props) => {\n  const { state, size } = props\n\n  return <div className={classNames({\n    'show-message': state.gameIsLose || state.levelComplete || state.startingMessage,\n    'hide-message': !state.gameIsLose && !state.levelComplete && !state.startingMessage\n  })} style={getStyle(size)}>\n    <div>\n      <div>\n        {\n          state.gameIsLose\n            ? 'You lose'\n            : state.levelComplete\n              ? `Level ${state.level} complete!`\n              : state.startingMessage\n                ? 'How to play?'\n                : null\n        }\n      </div>\n\n      <div>\n        {\n          state.gameIsLose\n            ? `Score: ${state.score}`\n            : state.levelComplete\n              ? 'Get ready!'\n              : state.startingMessage\n                ? <div className=\"rules\">\n                  <div>{'Tap a tile when it turns green.'}</div>\n                  <div>{'You win when no more tile is available.'}</div>\n                  <div>{\"Don't miss any or the game ends!\"}</div>\n                </div>\n                : null\n        }\n      </div>\n\n      <div>\n        {state.gameIsLose || state.startingMessage ? 'Swipe to start new game' : 'Swipe to start next level'}\n      </div>\n    </div>\n  </div>\n}\n\nGameMessage.propTypes = {\n  state: PropTypes.object.isRequired,\n  size: PropTypes.number.isRequired\n}\n\nexport default GameMessage\n","export const windowPadding = 100\nexport const gridPadding = 20\n\nexport const circleAnimationFrame = [\n  { width: '60px', height: '60px', opacity: '1' },\n  { width: '120px', height: '120px', opacity: '0' }\n]\n\nexport const circleAnimationTiming = {\n  duration: 600,\n  iterations: 1\n}\n","import { windowPadding, gridPadding } from '../utils/constants'\n\nconst getAvailableWindowSize = () => {\n  const availHeight = window.innerHeight - windowPadding\n\n  return window.innerWidth > availHeight\n    ? availHeight - gridPadding\n    : window.innerWidth - gridPadding\n}\n\nexport default getAvailableWindowSize\n","import getAvailableWindowSize from './getAvailableWindowSize'\n\nconst getCellSize = (length) => {\n  return Math.floor(getAvailableWindowSize() / Math.sqrt(length))\n}\n\nexport default getCellSize\n","import React from 'react'\nimport PropTypes from 'prop-types'\n\nimport Cell from './Cell'\nimport GameMessage from './GameMessage'\n\nimport getCellSize from '../helpers/getCellSize'\nimport getAvailableWindowSize from '../helpers/getAvailableWindowSize'\n\nconst getStyle = () => {\n  const size = getAvailableWindowSize()\n\n  return {\n    width: size,\n    height: size\n  }\n}\n\nconst Grid = (props) => {\n  const { state, onCellTap } = props\n  const size = getCellSize(state.cells.length)\n\n  return <div className=\"grid\" style={getStyle()}>\n    <GameMessage size={getAvailableWindowSize()}\n      state={state} />\n\n    {state.cells.map((cell, i) =>\n      <Cell className=\"game-cell\"\n        cell={cell} size={size}\n        onClick={() => onCellTap(cell)}\n        key={i}/>\n    )}\n  </div>\n}\n\nGrid.propTypes = {\n  state: PropTypes.object.isRequired,\n  onCellTap: PropTypes.func.isRequired\n}\n\nexport default Grid\n","import React, { Component } from 'react'\nimport PropTypes from 'prop-types'\nimport { circleAnimationFrame, circleAnimationTiming } from '../utils/constants'\n\nclass ProgressBar extends Component {\n  constructor (props) {\n    super(props)\n    this.animation = null\n    this.circle = React.createRef()\n  }\n\n  animate () {\n    this.animation = this.circle.current.animate(\n      circleAnimationFrame,\n      circleAnimationTiming\n    )\n  }\n\n  componentDidUpdate (nextProps) {\n    if (this.props.value !== nextProps.value) {\n      this.animate()\n    }\n  }\n\n  render () {\n    const { label, value } = this.props\n\n    return <div className=\"progress-bar\">\n      <div>{ label }</div>\n      <div>{ value }</div>\n\n      <div ref={this.circle}\n        className=\"animation-circle\">\n      </div>\n    </div>\n  }\n}\n\nProgressBar.propTypes = {\n  label: PropTypes.string.isRequired,\n  value: PropTypes.number.isRequired\n}\n\nexport default ProgressBar\n","\nexport const initialState = {\n  cells: [], // {label :: \"off\" | \"WAIT\" | \"TAP\", countdown :: Number | Null, index :: Number}\n  level: 1,\n  levelComplete: false,\n  startingMessage: true,\n  gameIsLose: false,\n  gameIsPassed: false,\n  score: 0,\n  best: 0\n}\n","import * as R from '@paqmind/ramda'\n\nexport const isGameInProgress = R.compose(\n  R.all(R.equals(R.F())),\n  R.values,\n  R.pick([\n    'gameIsLose',\n    'levelComplete',\n    'gameIsPassed',\n    'startingMessage'\n  ])\n)\n\nexport const isLevelCompleted = R.propEq(\n  'levelComplete',\n  R.T()\n)\n","const rand = (min, max) => min + Math.floor(Math.random() * max)\n\nexport default rand\n","import rand from './rand'\n\nconst pickRandom = (xs) => xs[rand(0, xs.length)]\n\nexport default pickRandom\n","import * as R from '@paqmind/ramda'\n\nconst decNumber = (x) => R.is(Object, x)\n  ? (x.countdown >= 2 ? { ...x, countdown: x.countdown - 1 } : x)\n  : null\n\nexport default decNumber\n","const getNumberOfCells = (lvl) => {\n  const size = lvl + 1\n  return size * size\n}\n\nexport default getNumberOfCells\n","import React from 'react'\nimport Store from '../helpers/store'\nimport Grid from './Grid'\nimport ProgressBar from './ProgressBar'\nimport { View, Panel, PanelHeader } from '@vkontakte/vkui'\n\nimport { initialState } from '../data/initialState'\nimport { isGameInProgress, isLevelCompleted } from '../utils/utils'\nimport { connecto } from '../connect'\nimport { pool } from '../helpers/pool'\n\nimport pickRandom from '../helpers/pickRandom'\nimport decNumber from '../helpers/decNumber'\nimport getNumberOfCells from '../helpers/getNumberOfCells'\n\nimport * as R from '@paqmind/ramda'\nimport * as K from 'kefir'\n\nimport connect from '@vkontakte/vk-connect'\n\nR.map2 = R.addIndex(R.map)\n\nexport default function () {\n  let newCellTimer = null\n\n  const action$ = pool()\n\n  const swipe$ = K.fromEvents(document.body, 'touchmove')\n    .throttle(100)\n    .map(_ => function swipe (state) {\n      return R.cond([\n        [isLevelCompleted, activateNextLevel],\n        [R.complement(isGameInProgress), beginNewGame],\n        [R.T, R.always(state)]\n      ])(state)\n    })\n\n  const ticker$ = K.interval(1000).map(_ => function tick (state) {\n    return R.ifElse(\n      timeOut,\n      interruptGame,\n      updateCells\n    )(state)\n  })\n\n  const state$ = Store(K.merge([\n    K.constant(() => initialState),\n    action$,\n    ticker$,\n    swipe$\n  ]))\n\n  // ------------------- game logic -------------------------------------\n\n  const beginNewGame = state => {\n    return R.pipe(\n      startGame,\n      initCells,\n      activateRandomCell\n    )(state)\n  }\n\n  const interruptGame = state => {\n    const { score, best } = state\n\n    connect.send('VKWebAppStorageSet', {\n      key: 'switchBestScore',\n      value: String(best)\n    })\n\n    return R.pipe(\n      initCells,\n      R.assoc('gameIsLose', R.T),\n      R.assoc('best', score > best ? score : best)\n    )(state)\n  }\n\n  const activateNextLevel = state => {\n    return R.pipe(\n      startLevel,\n      initCells,\n      activateRandomCell\n    )(state)\n  }\n\n  const updateCells = state => {\n    return R.over2(\n      'cells',\n      R.map(R.pipe(switchWaitToTap, decNumber))\n    )(state)\n  }\n\n  function initCells (state) {\n    const numberOfCells = getNumberOfCells(state.level)\n    const cells = R.map2((_, i) => ({\n      label: 'off',\n      countdown: null,\n      index: i\n    }), R.range(0, numberOfCells))\n\n    return {\n      ...state,\n      cells\n    }\n  }\n\n  function startGame (state) {\n    return {\n      ...state,\n      startingMessage: false,\n      gameIsLose: false,\n      gameIsPassed: false,\n      score: 0,\n      level: 1\n    }\n  }\n\n  function startLevel (state) {\n    return {\n      ...state,\n      levelComplete: false,\n      level: R.inc(state.level)\n    }\n  }\n\n  function onCellTap (cell) {\n    function tapHandler (state) {\n      if (cell.countdown != null && cell.label !== 'WAIT') {\n        return {\n          ...state,\n          score: state.score + 1,\n          cells: R.set2([cell.index, 'countdown'],\n            5, R.set2([cell.index, 'label'], 'WAIT', state.cells))\n        }\n      } else {\n        return state\n      }\n    }\n\n    action$.plug(tapHandler)\n  }\n\n  function activateRandomCell (state) {\n    let cells = state.cells\n    const offCells = R.filter(cell => cell.countdown == null, cells)\n\n    if (offCells.length) {\n      const offCell = pickRandom(offCells)\n\n      cells = R.pipe(\n        R.set2([offCell.index, 'countdown'], 5),\n        R.set2([offCell.index, 'label'], 'WAIT')\n      )(state.cells)\n\n      clearTimeout(newCellTimer)\n      newCellTimer = setTimeout(() => {\n        action$.plug(activateRandomCell)\n      }, 6000)\n\n      return R.set2('cells', cells, state)\n    } else {\n      clearTimeout(newCellTimer)\n\n      return R.pipe(\n        initCells,\n        R.assoc('levelComplete', R.T())\n      )(state)\n    }\n  }\n\n  function timeOut (state) {\n    let loseStatus = false\n    state.cells.map(cell => {\n      if (cell.countdown === 1 && cell.label === 'TAP') {\n        loseStatus = true\n        clearTimeout(newCellTimer)\n      }\n    })\n\n    return loseStatus\n  }\n\n  function switchWaitToTap (cell) {\n    return cell.countdown === 1 && cell.label === 'WAIT'\n      ? { label: 'TAP', countdown: 4, index: cell.index }\n      : cell\n  }\n\n  // function gameIsPassed (state) {\n  //   return {\n  //     ...state,\n  //     gameIsPassed: true\n  //   }\n  // }\n\n  // function startLevelBtnHandler () {\n  //   action$.plug(startLevel)\n  //   action$.plug(initCells)\n  //   action$.plug(activateRandomCell)\n  // }\n\n  // function startNewGameBtnHandler () {\n  //   action$.plug(startGame)\n  //   action$.plug(initCells)\n  //   action$.plug(activateRandomCell)\n  // }\n\n  action$.plug(initCells)\n\n  // --------------------------------------------------------------------\n\n  const Component = connecto(\n    { state: state$ },\n    ({ state }) => <View activePanel=\"main\">\n      <Panel id=\"main\" theme={'white'}>\n        <PanelHeader theme={'alternate'} noShadow={true}>\n          Switch\n        </PanelHeader>\n\n        <div className=\"game\">\n          <div className=\"game-progress\">\n            <ProgressBar label={'Level'}\n              value={state.level} />\n\n            <ProgressBar label={'Score'}\n              value={state.score} />\n\n            <ProgressBar label={'Best'}\n              value={state.best} />\n          </div>\n\n          <Grid state={state}\n            onCellTap={onCellTap}/>\n        </div>\n      </Panel>\n    </View>\n  )\n\n  return <Component/>\n}\n","import React from 'react'\nimport ReactDOM from 'react-dom'\nimport Game from './components/Game'\nimport connect from '@vkontakte/vk-connect'\nimport '@vkontakte/vkui/dist/vkui.css'\nimport './styles/main.scss'\n\nconnect.send('VKWebAppInit')\n\nReactDOM.render(\n  <Game/>,\n  document.getElementById('app')\n)\n","import K from 'kefir'\n\nexport const pool = () => {\n  const pool = K.pool()\n  const _plug = pool.plug.bind(pool)\n  pool.plug = function (x) {\n    if (x instanceof K.Property || x instanceof K.Stream || x instanceof K.Observable) {\n      _plug(x)\n    } else {\n      _plug(K.constant(x))\n    }\n  }\n  return pool\n}\n","import React, { Component } from 'react'\nimport connect from '@vkontakte/vk-connect'\nimport * as R from '@paqmind/ramda'\nimport * as K from 'kefir'\n\nexport const connecto = (streamsToProps, ComponentToWrap) => {\n  class Container extends Component {\n    constructor (props) {\n      super(props)\n      this.state = {}\n    }\n\n     UNSAFE_componentWillMount () {\n      const props$ = K.combine(streamsToProps)\n        .throttle(20, { leading: false })\n\n      this.sb = props$.observe(data => {\n        this.setState(data)\n      })\n\n      connect.subscribe(event => {\n        if (!event.detail) {\n          return\n        }\n\n        const { type, data } = event.detail\n\n        if (type === 'VKWebAppStorageGetResult') {\n          console.log(data)\n          const switchBestKey = data.keys.find(item => item.key === 'switchBest')\n\n          if (switchBestKey && switchBestKey.value) {\n            this.setState(R.set2('best', switchBestKey.value, this.state))\n          }\n        }\n      })\n\n      connect.send('VKWebAppStorageSet', {\n        key: 'switchBest',\n        value: '322'\n      })\n\n      connect.send('VKWebAppStorageGet', { keys: ['switchBest'] })\n    }\n\n    componentWillUnmount () {\n      this.sb.unsubscribe()\n      connect.unsubscribe()\n    }\n\n    render () {\n      return React.createElement(ComponentToWrap, R.merge(this.props, this.state), this.props.children)\n    }\n  }\n\n  return Container\n}\n"],"sourceRoot":""}